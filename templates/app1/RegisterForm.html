{% load static %}
<html>
    <head></head>
    <body>
        
        <div class="wrapper">
            <div class="background-image"></div>

            <div class="form-container">
                <div class="register-box">
                    <h1>Register</h1>

                    <p id="UsernameTaken"></p>

                    <input type="text" id="UsernameInputField" placeholder="Username">
                    <input type="password" id="PasswordInputField" placeholder="Password">

                    <p id="plen">Password must contain more than 4 characters</p>
                    <p id="pcap">Password must include at least one uppercase letter</p>
                    <p id="psp">Password must include at least one special character: @ # $ %</p>

                    <input type="password" id="ConfirmPassInputField" placeholder="Confirm Password">

                    <button type="button" id="RegisterButton">Register</button>

                    <p class="login-link">
                        Already have an account? <a href="#">Log In</a>
                    </p>
                </div>
            </div>
        </div>
        
        <link rel="stylesheet" href="{% static 'cssapp1/Register.css' %}">

        <meta name="csrf-token" content="{{ csrf_token }}">
        <script>
            const csrftoken = document.querySelector('[name=csrf-token]').content;

            let time
            let abortcontroller = null
            let result = {length:false, specialch:false, capitalch:false}
            let username = ' '

            let password = null
            let time2 = null

            document.getElementById('UsernameInputField').addEventListener('input', function(event) {
                clearTimeout(time)

                time = setTimeout(() => {
                    username = event.target.value
                },300)

            })

            document.getElementById('PasswordInputField').addEventListener('input', function(event) {
                clearTimeout(time2)
              
                time2 = setTimeout(() => {
                    password = event.target.value
                    console.log('moya odna')
                   
                    result = CheckPasswordValid(password)
                    console.log(result)
                    let plen = document.getElementById('plen')
                    let psp = document.getElementById('psp')
                    let pcap = document.getElementById('pcap')
                    
                    plen.style.color = result.length ? 'green':'red'
                    psp.style.color = result.specialch ? 'green':'red'
                    pcap.style.color = result.capitalch ? 'green':'red'

                }, 400)
            })


            function CheckPasswordValid(password) {
                let length = password.length >= 4
                let specialch = /[@#$%]/.test(password)
                let capitalch = /[A-Z]/.test(password)

                return {
                    length,
                    specialch, 
                    capitalch
                };
            }


            document.getElementById('RegisterButton').addEventListener('click', async function(){
                if (abortcontroller){
                    abortcontroller.abort()
                }

                abortcontroller = new AbortController()

                if (result.length && result.capitalch &&  result.specialch && username.trim() !== ''){
                    console.log('Match')

                    let response = await fetch('/ajax/CheckUsernameExists/',{
                        method:'POST',
                        headers: {
                            'Content-Type':'application/json',
                            'X-CSRFToken': csrftoken,
                        },
                        body: JSON.stringify({username:username, password:password}),
                        signal: abortcontroller.signal
                    })

                    let data = await response.json()
                    
                    if (data.passed){
                        // window.location.href = '/main/' es ete het karas gas slaqov 
                        window.location.replace('/main/');
                    
                    }
                    else {
                        document.getElementById('UsernameTaken').textContent = 'The username is taken.'
                    }
                }
                else {
                    console.log('Try Again')
                }
            })
      

            



            // async function CheckUsernameValid(signal){
            //     let response = await fetch('/ajax/CheckUsernameValid/', {
            //         method:'POST',
            //         headers: {
            //             'Content-Type':'application/json',
            //             'X-CSRFToken': csrftoken,
            //         },
            //         body: JSON.stringify({checkk:'lalalal'}),
            //         signal:signal,

            //     })
            //     console.log(response)

            //     let data = await response.json()
            //     // let data = await JSON.parse(response)
            // }





// 'Content-Type': 'application/json',
//                         'X-CSRFToken': csrftoken,
            // field.addEventListener('input', function() {
            //     console.log(field.value)
            // })

            // document.getElementById('mess').addEventListener('input', function(){

            //     console.log(this.value)
            // })
            // let time

            // field.addEventListener('input', function(event){

            //     let text = field.value 

            //     if (text === ''){
            //         return
            //     }

            //     console.log(text)
            //     clearTimeout(time)
            //     time = setTimeout(() => {
            //        console.log('yuhuu') 
            //     }, 400);
            //     console.log(event)
            //     console.log(event.target)
            // })

            
                  // let time = null
            // document.getElementById('UsernameInputField').addEventListener('input', function(e) {
            //     let text = event.target.value
            //     clearTimeout(time)
            //     time = setTimeout(() => {
            //         console.log(text)
            //     }, 300)
            // })

        </script>
    </body>
</html>